<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MB Tools</title>
  <style>
    * { box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, Segoe UI, Roboto, Arial, sans-serif; margin: 0; color: #222; }
    .wrap { display: grid; grid-template-rows: 67px 1fr; height: 100vh; }
    header { display: flex; align-items: center; gap: 8px; padding: 12px; border-bottom: 1px solid #e5e5e5; }
    header img { height: 47px; width: 88px; }
    .main { display: grid; grid-template-columns: 120px 1fr; height: calc(100vh - 67px); }
    nav { border-right: 1px solid #e5e5e5; padding: 8px; display: flex; flex-direction: column; gap: 6px; }
    nav button { text-align: left; background: #f7f7f7; border: 1px solid #e5e5e5; border-radius: 6px; padding: 8px; font-size: 12px; cursor: pointer; }
    nav button.active { background: #eaeaea; border-color: #d2d2d2; }
    section { padding: 12px; }
    .hidden { display: none; }
    .status-box { width: 100%; padding: 10px; border-radius: 6px; text-align: center; font-weight: 500; }
    .status-default { background: #f5f5f5; color: #666; }
    .status-ready { background: #dcfce7; color: #166534; border: 1px solid #bbf7d0; }
    .status-busy { background: #e0e7ff; color: #3730a3; border: 1px solid #c7d2fe; }
    .btn { padding: 8px 12px; border-radius: 6px; border: 1px solid #ddd; background: #111; color: #fff; cursor: pointer; font-size: 12px; }
    .btn[disabled] { opacity: .5; cursor: not-allowed; }
    .muted { color: #666; font-size: 12px; }
    .vspace { height: 10px; }
    .list { max-height: 100px; overflow-y: auto; font-size: 12px; color: #c00; }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <img src="assets/mb-logo.svg" alt="MB" />
    </header>
    <div class="main">
      <nav>
        <button id="tab-style" class="active">Styles→Vars</button>
        <button id="tab-icons">Icon Rename</button>
        <button id="tab-color">Color Palette</button>
      </nav>
      <section>
        <div id="panel-style">
          <p class="muted">Converter estilos de cor antigos para variables correspondentes.</p>
          <div class="vspace"></div>
          <div id="styleStatus" class="status-box status-default">Selecione ao menos um frame/section</div>
          <div class="vspace"></div>
          <button id="btnConvert" class="btn" disabled>Converter Seleção</button>
        </div>
        <div id="panel-icons" class="hidden">
          <p class="muted">Renomeia componentes selecionados para PascalCase com validação Lucide.</p>
          <div class="vspace"></div>
          <button id="btnRename" class="btn">Renomear Componentes</button>
          <div class="vspace"></div>
          <div id="iconsStatus" class="muted"></div>
          <div id="invalidList" class="list"></div>
        </div>
        <div id="panel-color" class="hidden">
          <p class="muted">Gera paleta de cores primária a partir de um valor HEX base.</p>
          <div class="vspace"></div>
          <label for="hexInput" class="muted">Cor Primária (HEX):</label>
          <div class="vspace"></div>
          <input
            id="hexInput"
            type="text"
            placeholder="#4133A6"
            style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;"
          />
          <div class="vspace"></div>
          <button id="btnGenerate" class="btn" disabled>Gerar e Aplicar Paleta</button>
          <div class="vspace"></div>
          <div id="colorStatus" class="status-box status-default">Insira um valor HEX válido (ex: #4133A6)</div>
          <div class="vspace"></div>
          <div id="palettePreview" class="muted"></div>
        </div>
      </section>
    </div>
  </div>

  <script>
    const tabStyle = document.getElementById('tab-style');
    const tabIcons = document.getElementById('tab-icons');
    const tabColor = document.getElementById('tab-color');
    const panelStyle = document.getElementById('panel-style');
    const panelIcons = document.getElementById('panel-icons');
    const panelColor = document.getElementById('panel-color');
    const styleStatus = document.getElementById('styleStatus');
    const btnConvert = document.getElementById('btnConvert');
    const btnRename = document.getElementById('btnRename');
    const btnGenerate = document.getElementById('btnGenerate');
    const iconsStatus = document.getElementById('iconsStatus');
    const invalidList = document.getElementById('invalidList');
    const hexInput = document.getElementById('hexInput');
    const colorStatus = document.getElementById('colorStatus');
    const palettePreview = document.getElementById('palettePreview');

    function showTab(tab) {
      // Remove active from all tabs
      tabStyle.classList.remove('active');
      tabIcons.classList.remove('active');
      tabColor.classList.remove('active');

      // Hide all panels
      panelStyle.classList.add('hidden');
      panelIcons.classList.add('hidden');
      panelColor.classList.add('hidden');

      // Show selected tab and panel
      if (tab === 'style') {
        tabStyle.classList.add('active');
        panelStyle.classList.remove('hidden');
      } else if (tab === 'icons') {
        tabIcons.classList.add('active');
        panelIcons.classList.remove('hidden');
      } else if (tab === 'color') {
        tabColor.classList.add('active');
        panelColor.classList.remove('hidden');
      }
    }

    tabStyle.onclick = () => showTab('style');
    tabIcons.onclick = () => showTab('icons');
    tabColor.onclick = () => showTab('color');

    // Style module state
    const styleState = { selectionState: 'none', styleCount: 0, isConverting: false };

    function updateStyleUI() {
      let text = 'Selecione ao menos um frame/section';
      let cls = 'status-default';
      if (styleState.isConverting) { text = 'Convertendo...'; cls = 'status-busy'; }
      else {
        if (styleState.selectionState === 'no-styles') text = 'Nenhum estilo detectado';
        else if (styleState.selectionState === 'ready') { text = `${styleState.styleCount} estilos detectados`; cls = 'status-ready'; }
      }
      styleStatus.textContent = text;
      styleStatus.className = `status-box ${cls}`;
      btnConvert.disabled = !(styleState.selectionState === 'ready' && !styleState.isConverting);
    }

    btnConvert.onclick = () => {
      styleState.isConverting = true;
      updateStyleUI();
      parent.postMessage({ pluginMessage: { module: 'style', type: 'convert' } }, '*');
    };

    // Icons module
    btnRename.onclick = () => {
      iconsStatus.textContent = 'Renomeando...';
      invalidList.textContent = '';
      parent.postMessage({ pluginMessage: { module: 'icons', type: 'rename-icons' } }, '*');
    };

    // Color Palette module
    const hexPattern = /^#([0-9A-F]{3}|[0-9A-F]{6})$/i;
    let isGenerating = false;

    function validateHex(hex) {
      return hexPattern.test(hex);
    }

    function updateColorUI() {
      const hex = hexInput.value.trim();
      const isValid = validateHex(hex);

      if (!hex) {
        colorStatus.textContent = 'Insira um valor HEX válido (ex: #4133A6)';
        colorStatus.className = 'status-box status-default';
        btnGenerate.disabled = true;
      } else if (!isValid) {
        colorStatus.textContent = 'Formato HEX inválido. Use #RGB ou #RRGGBB';
        colorStatus.className = 'status-box status-default';
        btnGenerate.disabled = true;
      } else if (isGenerating) {
        colorStatus.textContent = 'Gerando paleta de cores...';
        colorStatus.className = 'status-box status-busy';
        btnGenerate.disabled = true;
      } else {
        colorStatus.textContent = `Pronto para gerar paleta com ${hex}`;
        colorStatus.className = 'status-box status-ready';
        btnGenerate.disabled = false;
      }
    }

    // Real-time validation
    hexInput.oninput = updateColorUI;

    // Generate button click
    btnGenerate.onclick = () => {
      const hex = hexInput.value.trim();
      if (!validateHex(hex)) return;

      isGenerating = true;
      updateColorUI();
      palettePreview.textContent = '';

      parent.postMessage({
        pluginMessage: {
          module: 'color-palette',
          type: 'generate-palette',
          payload: { hex }
        }
      }, '*');
    };

    // Incoming messages
    window.onmessage = (event) => {
      const msg = event.data.pluginMessage;
      if (!msg) return;
      // Style
      if (msg.module === 'style') {
        switch (msg.type) {
          case 'selection-update':
            styleState.selectionState = !msg.hasSelection ? 'none' : (msg.count === 0 ? 'no-styles' : 'ready');
            styleState.styleCount = msg.count || 0;
            styleState.isConverting = false;
            updateStyleUI();
            break;
          case 'conversion-complete':
            styleState.isConverting = false;
            setTimeout(() => parent.postMessage({ pluginMessage: { module: 'style', type: 'check-selection' } }, '*'), 300);
            break;
          case 'error':
            styleState.isConverting = false;
            updateStyleUI();
            break;
        }
      }
      // Icons
      if (msg.module === 'icons') {
        if (msg.type === 'done') {
          if (msg.invalidNames && msg.invalidNames.length > 0) {
            iconsStatus.textContent = '⚠️ Alguns nomes são inválidos:';
            invalidList.innerHTML = msg.invalidNames.map((n) => `• ${n}`).join('<br/>');
          } else {
            iconsStatus.textContent = '✅ Todos os nomes são válidos!';
            invalidList.textContent = '';
          }
        }
      }
      // Color Palette
      if (msg.module === 'color-palette') {
        isGenerating = false;

        if (msg.type === 'palette-applied') {
          const { palette, updatedCount, baseColor } = msg.payload;
          colorStatus.textContent = `✅ ${updatedCount} variáveis criadas/atualizadas na coleção "colors-tokens"`;
          colorStatus.className = 'status-box status-ready';

          // Show palette preview
          const paletteEntries = Object.entries(palette);
          palettePreview.innerHTML = paletteEntries.map(([name, hex]) =>
            `<div style="display: flex; align-items: center; gap: 8px; margin: 4px 0;">
              <div style="width: 20px; height: 20px; background: ${hex}; border: 1px solid #ddd; border-radius: 3px;"></div>
              <span style="font-family: monospace; font-size: 11px;">${name}: ${hex}</span>
            </div>`
          ).join('');

        } else if (msg.type === 'error') {
          const { message } = msg.payload;
          colorStatus.textContent = `❌ Erro: ${message}`;
          colorStatus.className = 'status-box status-default';
          palettePreview.textContent = '';
        }

        updateColorUI();
      }
    };

    // Initial selection check for style module
    parent.postMessage({ pluginMessage: { module: 'style', type: 'check-selection' } }, '*');
  </script>
</body>
</html>
